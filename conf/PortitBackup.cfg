#!/usr/bin/python
# -*- coding: utf-8 -*-

import os, sys, logging
import time




# >f.st......
#   > - the item is received
#   f - it is a regular file
#   s - the file size is different
#   t - the time stamp is different


# .d..t......
#   . - the item is not being updated (though it might have attributes that are being modified)
#   d - it is a directory
#   t - the time stamp is different

# >f+++++++++
#   > - the item is received
#   f - a regular file
#   +++++++++ - this is a newly created item



# The relevant part of the rsync man page:

# -i, --itemize-changes

# Requests a simple itemized list of the changes that are being made to each file, including attribute changes.
# This is exactly the same as specifying --out-format='%i %n%L'.
# If you repeat the option, unchanged files will also be output, but only if the receiving rsync is at least version 2.6.7
# (you can use -vv with older versions of rsync, but that also turns on the output of other verbose messages).

# The "%i" escape has a cryptic output that is 11 letters long. The general format is like the string
#         YXcstpoguax   where:
#               Y is replaced by the type of update being done
#                   < means that a file is being transferred to the remote host (sent).
#                   > means that a file is being transferred to the local host (received).
#                   c means that a local change/creation is occurring for the item (such as the creation of a directory or the changing of a sy   mlink, etc.).
#                   h means that the item is a hard link to another item (requires --hard-links).
#                   . means that the item is not being updated (though it might have attributes that are being modified).
#                   * means that the rest of the itemized-output area contains a message (e.g. "deleting").
#
#               X is replaced by the file-type,
#                   f for a file
#                   d for a directory
#                   L for a symlink
#                   D for a device
#                   S for a special file (e.g. named sockets and fifos).

# The other letters in the string above are the actual letters that will be output
# if the associated attribute for the item is being updated or a "." for no change.
# Three exceptions to this are:
#       (1) a newly created item replaces each letter with a "+",
#       (2) an identical item replaces the dots with spaces, and
#       (3) an unknown attribute replaces each letter with a "?" (this can happen when talking to an older rsync).

# The attribute that is associated with each letter is as follows:

# c     means either that a regular file has a different checksum (requires --checksum)
#       or that a symlink, device, or special file has a changed value.
#       Note that if you are sending files to an rsync prior to 3.0.1, this change flag will be
#       present only for checksum-differing regular files.
# s     means the size of a regular file is different and will be updated by the file transfer.
# t     means the modification time is different and is being updated to the sender’s value (requires --times).
#       An alternate value of T means that the modification time will be set to the transfer time,
#       which happens when a file/symlink/device is updated without --times and when a symlink is changed
#       and the receiver can’t set its time.
#       (Note: when using an rsync 3.0.0 client, you might see the s flag combined with t instead of the
#       proper T flag for this time-setting failure.)
# p     means the permissions are different and are being updated to the sender’s value (requires --perms).
# o     means the owner is different and is being updated to the sender’s value (requires --owner and super-user privileges).
# g     means the group is different and is being updated to the sender’s value (requires --group and the authority to set the group).
# u     slot is reserved for future use.
# a     means that the ACL information changed.
# x     means that the extended attribute information changed.
#
# One other output is possible: when deleting files, the "%i" will output the string "*deleting" for each item
# that is being removed (assuming that you are talking to a recent enough rsync that it logs deletions instead
# of outputting them as a verbose message).





# The first character indicates what is happening to the file:

#   < means that a file is being transferred to the remote host (sent).
#   > means that a file is being transferred to the local host (received).
#   c means that a local change/creation is occurring for the item (such as the creation of a directory or the changing of a symlink, etc.).
#   h means that the item is a hard link to another item (requires --hard-links).
#   . means that the item is not being updated (though it might have attributes that are being modified).
#   * means that the rest of the itemized-output area contains a message (e.g. "deleting").

# The second character indicates what type of directory entry it is. Specifically:
#   f for file
#   d for directory
#   L for symbolic link
#   D for device
#   S for special file (e.g. socket or fifo   )

# The remaining columns are described below:
#   c means either that a regular file has a different checksum or that a symlink, device, or special file has a changed value.
#   s means the size of a regular file is different and will be updated by the file transfer.
#   t or T:
#       t means the modification time is different and is being updated to the sender's value
#       T means that the modification time will be set to the transfer time
#   p means the permissions are different and are being updated to the sender's value
#   o means the owner is different and is being updated to the sender's value
#   g means the group is different and is being updated to the sender's value
#   . unused

# The following columns may not be present, depending on your transfer options
# a means that the ACL information changed
# x means that the extended attribute information changed











# ##############################################################################################
# # Updates
# # --chmod=Dug+rwx : Aggiunto per permettere la creazione delle dir con uno specifico MASK.
# #                   Altrimenti (da windows) lo creava senza attributi. Non so perché.
# ##############################################################################################


# #########################################################################
# # Global Variables
# #########################################################################
loretoHome          = 'localhost'                    # prevede l'apertura di un tunnel SSH verso il pc di casa
loretoHome          = '192.168.1.21:22'
loretoHome          = 'loreto.homedns.org'
loretoHome          = 'loreto.dyndns.ws'
loretoHome          = '192.168.1.21'
loretoHome          = 'esil610'
loretoHomeViaItaca  = 'MyLoopback'              # Non funziona con ul nome
loretoHomeViaItaca  = '192.168.58.1'
loretoHomeViaItaca  = '192.168.0.22'

# #########################################################################
# # getTime()
# #########################################################################
def getTime():
    Tuple   = time.localtime()
    string  = time.strftime("%Y-%m-%d_%H-%M-%S", Tuple)
    string  = time.strftime("%Y-%m-%d", Tuple)
    return string

# #########################################################################
# # getcurrPath()
# #########################################################################
def getcurrPath():
    scriptDir   = os.path.split(os.path.abspath(sys.argv[0]))
    return scriptDir

backupSUFFIX = getTime()

MyKey = '"c:\Documents and Settings\f602250\.ssh\id_rsa"'
MyKey = '"/cygdrive/c/Documents and Settings/f602250/.ssh/id_rsa"'
MyKey = '"/cygdrive/c/Users/f602250/.ssh/id_rsa"'

# --protect-args             # no space-splitting; only wildcard special-chars
# --stats                    # give some file-transfer stats
# --iconv=ISO-8859-1,utf-8   # request charset conversion of filenames

rSync_BASE_Options = '--human-readable --progress --update --archive --links --delete-after --numeric-ids --compress'


Main = {
    'LOG_CONSOLE'           : logging.INFO,
    'LOG_FILE'              : logging.DEBUG,
    'Type of Command'       : 'TRAPPED',
    'Type of Command'       : 'SYSTEM',

    'grep options'          : ' | grep -iv "total size is" | grep -iv "bytes/sec" | grep -iv " file list" | grep -iv " to consider" | grep -iv "(xfer#"',

        # --------------------------------------------------------------------
        # - Vale per tutti i progetti del file
        # - Quelli all'interno del progetto si aggiungono a questi valori
        # --------------------------------------------------------------------
    'rSync BASE Options'        : rSync_BASE_Options,
    'rSync BASE Options.+01'    : "--protect-args",
    'rSync BASE Options.+02'    : "--iconv=ISO-8859-1,utf-8",

    'rSync EXCLUDED PATTERN'    : '--exclude *.log.* --exclude /Thumbs.db --exclude Cache/ --exclude *Cache*',
    'rSync OTHER Options'       : "--chmod=Dug+rx,Du+w,Fugo+r,Fu+w",
    'rSync LOG FILE'            : 'RsyncEXE.LOG',
}


def Test_DiscoX():


    UserID        = 'pi';  machineName = '192.168.58.22'; port = 22
    sourceRootDIR = 'LOCAL:/cygdrive/d/LnBdi'        ; destRootDIR = '%s@%s:/media/WD640GB/LoretoBK' % (UserID, machineName)

    MainData = {

        'rSync OTHER Options.+01'    : '-e "ssh -p %d -l %s" -i %s' % (port, UserID, MyKey),
        'rSync OTHER Options.+02'    : '--rsync-path="sudo rsync"',

        'rSync EXCLUDED PATTERN.+01' : '--delete-excluded',

            # ---------------------------------------------------
            # -  MyData
            # ---------------------------------------------------
        'Flusso_MyData' : {

            'Source System'       : '%s/Loreto/MyData'  % (sourceRootDIR),
            'Target System'       : '%s/MyData'         % (destRootDIR),

            'PATHS' : [
               # [Source subDir                ,Dest include, BACKUP,   BackupSUFFUX],
                ['/Photos/'                      ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Ln-eBooks/'                   ,'=',  [],     False,    backupSUFFIX,    ],
                ['/MP3/'                         ,'=',  [],     False,    backupSUFFIX,    ],
                ['/MP4/'                         ,'=',  [],     False,    backupSUFFIX,    ],
                ['/OS-Drivers/'                  ,'=',  [],     False,    backupSUFFIX,    ],
                ['/PhotosDVD/'                   ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Videos/'                      ,'=',  [],     False,    backupSUFFIX,    ],
            ],
        },

            # ---------------------------------------------------
            # -  Progettid

            # ---------------------------------------------------
        'Flusso_Progetti' : {

            'Source System'       : '%s/BdI'            % (sourceRootDIR),
            'Target System'       : '%s/Banca_Italia'   % (destRootDIR),

            'PATHS' : [
              # [Source subDir                ,Dest include, BACKUP,   BackupSUFFUX],
                ['/Configurazioni/'             ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Amministrazione/'            ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Archivio/'                   ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Office/'                     ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Progetti/'                   ,'=',  [],     False,    backupSUFFIX,    ],
            ],
        },

    }
    return MainData



##########################################################################################
# # Portit_DiscoD()
##########################################################################################
def Portit_DiscoD():
    UserID        = 'pi';  machineName = '192.168.58.22'; port = 22
    sourceRootDIR = 'LOCAL:/cygdrive/d/LnBdi'        ; destRootDIR = '%s@%s:/media/WD640GB/LoretoBK' % (UserID, machineName)

    MainData = {

        'rSync OTHER Options.+01'    : '-e "ssh -p %d -l %s" -i %s' % (port, UserID, MyKey),
        'rSync OTHER Options.+02'    : '--rsync-path="sudo rsync"',

        'rSync EXCLUDED PATTERN.+01' : '--delete-excluded',

            # ---------------------------------------------------
            # -  MyData
            # ---------------------------------------------------
        'Flusso_MyData' : {

            'Source System'       : '%s/Loreto/MyData'  % (sourceRootDIR),
            'Target System'       : '%s/MyData'         % (destRootDIR),

            'PATHS' : [
               # [Source subDir                ,Dest include, BACKUP,   BackupSUFFUX],
                ['/Videos/'                      ,'=',  [],     False,    backupSUFFIX,    ],
                ['/OS-Drivers/'                  ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Photos/'                      ,'=',  [],     False,    backupSUFFIX,    ],
                ['/PhotosDVD/'                   ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Ln-eBooks/'                   ,'=',  [],     False,    backupSUFFIX,    ],
                ['/MP3/'                         ,'=',  [],     False,    backupSUFFIX,    ],
                ['/MP4/'                         ,'=',  [],     False,    backupSUFFIX,    ],
            ],
        },

            # ---------------------------------------------------
            # -  Progettid

            # ---------------------------------------------------
        'Flusso_Progetti' : {

            'Source System'       : '%s/BdI'            % (sourceRootDIR),
            'Target System'       : '%s/Banca_Italia'   % (destRootDIR),

            'PATHS' : [
              # [Source subDir                ,Dest include, BACKUP,   BackupSUFFUX],
                ['/Amministrazione/'            ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Archivio/'                   ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Configurazioni/'             ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Office/'                     ,'=',  [],     False,    backupSUFFIX,    ],
                ['/Progetti/'                   ,'=',  [],     False,    backupSUFFIX,    ],
            ],
        },

    }
    return MainData


##########################################################################################
# # Portit_DiscoE()
##########################################################################################
def Portit_DiscoE():

    UserID        = 'pi';  machineName = '192.168.58.22'; port = 22
    sourceRootDIR = 'LOCAL:/cygdrive/e'        ; destRootDIR = '%s@%s:/media/WD640GB/LoretoBK' % (UserID, machineName)
    # sourceRootDIR = 'LOCAL:/cygdrive/e'        ; destRootDIR = 'LOCAL:/cygdrive/h/LoretoBK'


    MainData = {

        'rSync EXCLUDED PATTERN'  : '+ --delete-excluded',
        'rSync OTHER Options'     : "+ -e ssh --rsync-path='sudo rsync' -ax -i %s" % (MyKey),

        'Flusso_DiscoL' : {

            'Source System'       : '%s'   % (sourceRootDIR),
            'Target System'       : '%s'   % (destRootDIR),

            'PATHS' : [
              # [Source subDir                ,Dest include, BACKUP,   BackupSUFFUX],
                ['/Audio-Libri/'           ,'=',    [],   False,    backupSUFFIX,   ],
                ['/OS-Images/Win'          ,'=',    [],   False,    backupSUFFIX,   ],
                ['/VM-Images'              ,'=',    [],   False,    backupSUFFIX,   ],
                ['/VM-SharedFolder'        ,'=',    [],   False,    backupSUFFIX,   ],
            ],
        }
    }

    return MainData

##########################################################################################
# # Portit_DiscoL()
##########################################################################################
def Portit_DiscoL():
    UserID        = 'pi';  machineName = '192.168.58.22'; port = 22
    sourceRootDIR = 'LOCAL:/cygdrive/l'        ; destRootDIR = '%s@%s:/media/WD640GB/LoretoBK' % (UserID, machineName)

    MainData = {
        'rSync EXCLUDED PATTERN'  : '+ --delete-excluded',
        'rSync OTHER Options'     : "+ -e ssh --rsync-path='sudo rsync' -ax -i %s" % (MyKey),

        'Flusso_DiscoL' : {

            'Source System'       : '%s'          % (sourceRootDIR),
            'Target System'       : '%s/DiscoL'   % (destRootDIR),


            'PATHS' : [
              # [Source subDir                ,Dest include, BACKUP,   BackupSUFFUX],
                ['/Games/'                     ,'=',    [],   False,     backupSUFFIX,   ],
                ['/Images/'                     ,'=',   [],   False,     backupSUFFIX,   ],
                ['/LnOther/'                    ,'=',   [],   False,     backupSUFFIX,   ],
                ['/LnSite/'                     ,'=',   [],   False,     backupSUFFIX,   ],
                ['/Loreto/'                     ,'=',   [],   True,      backupSUFFIX,   ],
                ['/Loreto_DOC/'                 ,'=',   [],   True,      backupSUFFIX,   ],
                ['/Loreto_OtherDOC/'            ,'=',   [],   True,      backupSUFFIX,   ],
                ['/Loreto_Tech_Doc/'            ,'=',   [],   True,      backupSUFFIX,   ],
                ['/PortableApps/'               ,'=',   [],   False,     backupSUFFIX,   ],
                ['/_Film/'                      ,'=',   [],   False,     backupSUFFIX,   ],
            ],
        }
    }

    return MainData




#################################################################################################
# # Portit_LnFree
#################################################################################################
def Portit_LnFree():
    UserID        = 'pi';  machineName = '192.168.58.22'; port = 22
    sourceRootDIR = 'LOCAL:/cygdrive/l'        ; destRootDIR = '%s@%s:/media/WD640GB/LoretoBK' % (UserID, machineName)

    machineName         = loretoHomeViaItaca
    UserID              = 'pi'
    login               = '%s@%s'       % (UserID, machineName)

    sourceRootDIR       = 'LOCAL:/cygdrive/l'

    destRootDIR         = '%s@%s:/media/WD640GB'       % (UserID, machineName)
    destRootDIR         = 'LOCAL:/cygdrive/h/LoretoBK'


    MainData = {

        'Flusso_DiscoL' : {
            'rSync OTHER Options'     : "+ -e ssh --rsync-path='sudo rsync' -ax -i %s" % (MyKey),

            'Source System'       : '%s/LnFree'   % (sourceRootDIR),
            'Target System'       : '%s/LnFree'   % (destRootDIR),

            'PATHS' : [
                ['/Audio/',             '=',  [],     False,    backupSUFFIX,    ],
                ['/Bench/',             '=',  [],     False,    backupSUFFIX,    ],
                ['/CAD/',               '=',  [],     False,    backupSUFFIX,    ],
                ['/CD-DVDTools/',       '=',  [],     False,    backupSUFFIX,    ],
                ['/Crypto/',            '=',  [],     False,    backupSUFFIX,    ],
                ['/CygwinPortable/',    '=',  [],     False,    backupSUFFIX,    ],
                ['/DBase/',             '=',  [],     False,    backupSUFFIX,    ],
                ['/DeskTop/',           '=',  [],     False,    backupSUFFIX,    ],
                ['/Disk/',              '=',  [],     False,    backupSUFFIX,    ],
                ['/DLLs/',              '=',  [],     False,    backupSUFFIX,    ],
                ['/Editors/',           '=',  [],     False,    backupSUFFIX,    ],
                ['/Elettronica/',       '=',  [],     False,    backupSUFFIX,    ],
                ['/Files/',             '=',  [],     False,    backupSUFFIX,    ],
                ['/Graphics/',          '=',  [],     False,    backupSUFFIX,    ],
                ['/IM-Chat/',           '=',  [],     False,    backupSUFFIX,    ],
                ['/Mails/',             '=',  [],     False,    backupSUFFIX,    ],
                ['/Matematica/',        '=',  [],     False,    backupSUFFIX,    ],
                ['/MMedia/',            '=',  [],     False,    backupSUFFIX,    ],
                ['/Network/',           '=',  [],     False,    backupSUFFIX,    ],
                ['/Office/',            '=',  [],     False,    backupSUFFIX,    ],
                ['/OpSys/',             '=',  [],     False,    backupSUFFIX,    ],
                ['/Organizer/',         '=',  [],     False,    backupSUFFIX,    ],
                ['/OS/',                '=',  [],     False,    backupSUFFIX,    ],
                ['/Pgm/',               '=',  [],     False,    backupSUFFIX,    ],
                ['/PythonUtils/',       '=',  [],     False,    backupSUFFIX,    ],
                ['/Registry/',          '=',  [],     False,    backupSUFFIX,    ],
                ['/Scheduler/',         '=',  [],     False,    backupSUFFIX,    ],
                ['/School/',            '=',  [],     False,    backupSUFFIX,    ],
                ['/ScreenSaver/',       '=',  [],     False,    backupSUFFIX,    ],
                ['/Security/',          '=',  [],     False,    backupSUFFIX,    ],
                ['/SmartUtils/',        '=',  [],     False,    backupSUFFIX,    ],
                ['/Suite_MiTec_Utils/', '=',  [],     False,    backupSUFFIX,    ],
                ['/Suite_NirSoft/',     '=',  [],     False,    backupSUFFIX,    ],
                ['/Suite_SysInternals/','=',  [],     False,    backupSUFFIX,    ],
                ['/SynchBackup/',       '=',  [],     False,    backupSUFFIX,    ],
                ['/System/',            '=',  [],     False,    backupSUFFIX,    ],
                ['/SystemClean/',       '=',  [],     False,    backupSUFFIX,    ],
                ['/UnixUtils/',         '=',  [],     False,    backupSUFFIX,    ],
                ['/UnixUtils_OK0/',     '=',  [],     False,    backupSUFFIX,    ],
                ['/VideoTools/',        '=',  [],     False,    backupSUFFIX,    ],
                ['/X2/',                '=',  [],     False,    backupSUFFIX,    ],
                ['/_Drivers/',          '=',  [],     False,    backupSUFFIX,    ],
                ['/_LnPortable/',       '=',  [],     True,     backupSUFFIX,    ],
                ['/_Tools/',            '=',  [],     False,    backupSUFFIX,    ],
                ['/_UnderTEST/',        '=',  [],     False,    backupSUFFIX,    ],
            ],
        },
    }
    return MainData

